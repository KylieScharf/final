---
title: "STAT 331/531: Final Project"
author: "Kylie Scharf, Emma Durler, Jordan Klapper, Mason Pudwill"
format: 
  html:
    embed-resources: true
    code-tools: true
    toc: true
    number-sections: true
    code-fold: true
editor: source
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

## Introduction

Our research is aimed at investigating the potential relationship between fertility rates, measured by the average number of babies per woman, and life expectancy measured in yearsacross various countries worldwide over time. The explanatory variable of interest is the average number of babies per women per year and country measured in number of babies which we hope to explain the response variable that is the life expectancy per year and country measured in years. 

In search of an answer to our question, we decided to use data sourced from Gap minder to investigate a possible relationship. We used two data sets, one containing information of the average amount of babies per woman per country and year, and one containing life expectancy per country per year. The two data sets we obtained are children_per_woman_total_fertility.csv and lex.csv. To clean the data, we decided to first subset the two original large data sets imported to only contain observations from the years 1900 to 2000. We also decided to create a new variable called decade so that we may average over this in the future to reduce the amount of output. We then decided to use an inner join to join our data because we only wanted to include observations with an observed value within both data sets. Each observational unit (row in the data set) in our joined data represented one specific country in one specific year and contains the average values of both variables. There are 186 countries in our final data set. 

We hypothesized a negative relationship between average babies per year per country and average life expectancy per year per country. That is, we expect average life expectancy to decrease as the average amount of babies per woman increase. We believe this because as the average babies per woman increases, the population increases which creates more competition for limited resources. This is likely to lead to earlier deaths, and an increased number of deaths due to factors other than just natural causes. Our motivation for selecting this topic stems from a blend of personal and societal interests. Firstly, as individuals contemplating starting families, we're naturally curious about the potential impacts of fertility rates on broader societal metrics like life expectancy. Understanding these dynamics can inform our personal decisions and contribute to our collective understanding of family planning.



```{r}
#| label: setup
#| output: false
library(tidyverse)
babies <- read_csv(here::here("children_per_woman_total_fertility.csv"))
life <- read_csv(here::here("lex.csv"))

```



```{r}
#| output: false
#data cleaning
babies <- babies |>
  select(country, `1900`:`2000`) |>
  pivot_longer(`1900`:`2000`,
               names_to = "Year",
               values_to = "Babies_Per_Woman")

life <- life |>
  select(country, `1900`:`2000`) |>
  pivot_longer(`1900`:`2000`,
               names_to = "Year",
               values_to = "Life_Expectancy")

full <- inner_join(babies, life) |>
  mutate(decade = case_when(Year %in% c(1900:1910) ~ "00s",
                            Year %in% c(1910:1920) ~ "10s",
                            Year %in% c(1920:1930) ~ "20s",
                            Year %in% c(1930:1940) ~ "30s",
                            Year %in% c(1940:1950) ~ "40s",
                            Year %in% c(1950:1960) ~ "50s",
                            Year %in% c(1960:1970) ~ "60s",
                            Year %in% c(1970:1980) ~ "70s",
                            Year %in% c(1980:1990) ~ "80s",
                            Year %in% c(1990:2000) ~ "90s"
                            )
         ) 

```

## Linear Regression

To investigate our hypothesis, we first graphed the data in our combined data set. We averaged the data for each country over all years that were in the data set so that each country is only represented once in the plot. Each data point in the plot below represents one country where the average babies per woman in that country is plotted on the x-axis and the average life expectancy in that country is plotted on the y-axis. 


```{r}
#second plot
full |>
  group_by(country) |>
  summarize(avg_life_exp = mean(Life_Expectancy), avg_babies = mean(Babies_Per_Woman)) |>
  ggplot(aes(x = avg_babies, y = avg_life_exp)) +
  geom_jitter() +
  geom_smooth(method = "lm") + 
  labs(x = "Average Babies Per Woman Per Country", subtitle = "Average Life Expectancy Per Country", y = "", title = "Average Babies Per Woman Vs. Average Life Expectancy")

```

As we can see in the graph above, there does appear to be a moderately strong and linear negative relationship between the two variables. Our hypothesis seems correct at the moment. There do not appear to be any points that do not fit the overall pattern. 

We next wanted to analyze how the relationship between the variables changed over time. To do this, we used our decade variable that we created and grouped by not only country, but also decade. We then averaged both babies per woman and life expectancy over both country country and decade to obtain the graph below. 
  
```{r}
#first plot

full |>
  group_by(country, decade) |>
  summarize(avg_life_exp = mean(Life_Expectancy), 
            avg_babies = mean(Babies_Per_Woman)) |>
  ggplot(aes(x = avg_babies, y = avg_life_exp)) +
  geom_jitter() +
  geom_smooth(method = "lm") + 
  facet_wrap(.~decade) +
  labs(x = "Average Babies Per Woman Per Country", subtitle = "Average Life Expectancy Per Country", y = "", title = "Average Babies Per Women Vs. Average Life Expectancy Across Decades")
```

As seen in this plot, it does not seem like the relationship between the variables is changing much over time. It does appear, however, that the average life expectancy is increasing over time which is causing our graph to shift upwards as decades increase. 


We then wanted to test our hypothesized relationship by fitting a model to the data. We fit a linear model to the relationship between our two variables to estimate a possible relationship. 

```{r}

model_data <- full |>
  group_by(country) |>
  summarize(avg_life_exp = mean(Life_Expectancy), avg_babies = mean(Babies_Per_Woman))
  
my_model <- lm(avg_life_exp ~ avg_babies, data = model_data)

my_model

```

The Coefficients presented in the model are an intercept of 73.199 and a slope of -4.469, further supporting our hypothesized negative relationship. The intercept obtained represents that we estimate an average life expectancy of around 73 years when on average, a woman has 0 babies. The slope represents that every increase of 1 baby in average babies per woman, we estimate an average decrease of around 4.5 years in average life expectancy. Written out, our model is (avg_life_exp)^ = 73.199 - 4.496(avg_babies).

```{r}
#assumptions
library(broom)

tib <- augment(my_model)

#hist of resids
ggplot(data = tib, aes(x = .resid))+
  geom_histogram()

#resid vs predicted

ggplot(data = tib, aes(x = .fitted, y = .resid)) +
  geom_point()
```

The method we used is "lm" to fit a linear regression line to our data. This is appropriate, firstly, because our data appears to follow a linear pattern. We can also assume our data are independent as knowing one person's life expectancy should not predict another person's. When plotting a histogram of the residuals obtained, we can also see that they are roughly normally distributed with a slight right skew. In a plot of residuals vs. predicted values, we can also see that we have roughly equal variability for each predicted value.

## Model Fit
```{r}
library(broom)

tib2 <- tib|>
  summarize(variance_residual = var(.resid), variance_fitted = var(.fitted), variance_response = var(avg_life_exp))


```

The variability in average life expectancy that is accounted for by the relationship with the average amount of babies born per woman can be calculated from the table above. This can be seen when dividing the total variance `r tib2$variance_response ` and the variance in the fitted values `r tib2$variance_fitted` to obtain a percentage of roughly `r round((tib2$variance_fitted/tib2$variance_response) * 100)`. This suggests the quality of our model is high because about `r round((tib2$variance_fitted/tib2$variance_response) * 100)`% of the variablity in the response was accounted for by our regression model. 
